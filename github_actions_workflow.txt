name: ğŸ“Š AI ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  push:
    branches: [ main ]
    paths: 
      - 'data/*.xlsx'
      - 'data/*.xls'
      - 'data.csv'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/*.xlsx'
      - 'data/*.xls'
      - 'data.csv'
  schedule:
    # ë§¤ì›” 1ì¼ ì˜¤ì „ 9ì‹œ (í•œêµ­ì‹œê°„ ê¸°ì¤€)
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ê°•ì œ ì—…ë°ì´íŠ¸ ì‹¤í–‰'
        required: false
        default: 'false'

# ê¶Œí•œ ì„¤ì •
permissions:
  contents: write
  pages: write
  id-token: write

# ë™ì‹œ ì‹¤í–‰ ì œí•œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # 1ë‹¨ê³„: ë°ì´í„° ì²˜ë¦¬ ë° ë³€í™˜
  process-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install pandas openpyxl xlrd chardet python-dateutil
    
    - name: ğŸ” ì—‘ì…€ íŒŒì¼ í™•ì¸
      id: check-excel
      run: |
        if ls data/*.xlsx 1> /dev/null 2>&1 || ls data/*.xls 1> /dev/null 2>&1; then
          echo "excel_found=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ ì—‘ì…€ íŒŒì¼ ë°œê²¬ë¨"
        else
          echo "excel_found=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ ì—‘ì…€ íŒŒì¼ ì—†ìŒ - ê¸°ì¡´ CSV ì‚¬ìš©"
        fi
    
    - name: ğŸ”„ ì—‘ì…€ì„ CSVë¡œ ë³€í™˜
      if: steps.check-excel.outputs.excel_found == 'true'
      run: |
        python3 << 'EOF'
        import pandas as pd
        import glob
        import os
        from datetime import datetime
        
        # ê°€ì¥ ìµœê·¼ ì—‘ì…€ íŒŒì¼ ì°¾ê¸°
        excel_files = glob.glob('data/*.xlsx') + glob.glob('data/*.xls')
        if not excel_files:
            print("ì—‘ì…€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            exit(1)
        
        # íŒŒì¼ ìˆ˜ì • ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
        latest_file = max(excel_files, key=os.path.getmtime)
        print(f"ğŸ“„ ì²˜ë¦¬ ì¤‘ì¸ íŒŒì¼: {latest_file}")
        
        try:
            # ì—‘ì…€ íŒŒì¼ ì½ê¸°
            df = pd.read_excel(latest_file, sheet_name='AI ë“±ë¡ì œ')
            
            # ë¹ˆ í–‰ ì œê±°
            df = df.dropna(how='all')
            
            # ì²« ë²ˆì§¸ ì»¬ëŸ¼ì´ ìˆ«ìì¸ í–‰ë§Œ í•„í„°ë§ (í—¤ë” ì œì™¸í•œ ì‹¤ì œ ë°ì´í„°)
            df_filtered = df[pd.to_numeric(df.iloc[:, 0], errors='coerce').notna()]
            
            print(f"ğŸ“Š ì´ {len(df_filtered)}ê°œì˜ AI ì„œë¹„ìŠ¤ ë°ì´í„° ì²˜ë¦¬ë¨")
            
            # CSVë¡œ ì €ì¥
            df.to_csv('data.csv', index=False, encoding='utf-8-sig')
            print("âœ… CSV íŒŒì¼ ìƒì„± ì™„ë£Œ: data.csv")
            
            # í†µê³„ ì •ë³´ ì €ì¥
            stats = {
                'total_services': len(df_filtered),
                'update_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'source_file': os.path.basename(latest_file)
            }
            
            with open('data_stats.txt', 'w', encoding='utf-8') as f:
                f.write(f"ì´ ì„œë¹„ìŠ¤ ìˆ˜: {stats['total_services']}\n")
                f.write(f"ì—…ë°ì´íŠ¸ ì‹œê°„: {stats['update_date']}\n")
                f.write(f"ì›ë³¸ íŒŒì¼: {stats['source_file']}\n")
            
        except Exception as e:
            print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            exit(1)
        EOF
    
    - name: ğŸ“Š ë°ì´í„° ê²€ì¦
      run: |
        if [ -f "data.csv" ]; then
          lines=$(wc -l < data.csv)
          echo "ğŸ“ˆ CSV íŒŒì¼ ë¼ì¸ ìˆ˜: $lines"
          
          if [ $lines -lt 2 ]; then
            echo "âŒ CSV íŒŒì¼ì— ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… ë°ì´í„° ê²€ì¦ ì™„ë£Œ"
        else
          echo "âŒ CSV íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          exit 1
        fi
    
    - name: ğŸ¯ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -f "data_stats.txt" ]; then
          echo "ğŸ“‹ ë°ì´í„° í†µê³„:"
          cat data_stats.txt
        fi
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if git diff --quiet; then
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        else
          git add data.csv data_stats.txt
          git commit -m "ğŸ“Š AI ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ $(date +'%Y-%m-%d %H:%M')" || echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          git push origin main || echo "í‘¸ì‹œí•  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi

  # 2ë‹¨ê³„: GitHub Pages ë°°í¬
  deploy:
    needs: process-data
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ›’ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        ref: main
    
    - name: ğŸ”§ Pages ì„¤ì •
      uses: actions/configure-pages@v4
    
    - name: ğŸ“¦ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: ğŸš€ GitHub Pages ë°°í¬
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: ğŸ‰ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
        echo "ğŸ”— ì‚¬ì´íŠ¸ URL: ${{ steps.deployment.outputs.page_url }}"
        
        if [ -f "data_stats.txt" ]; then
          echo "ğŸ“Š ìµœì‹  ë°ì´í„° í˜„í™©:"
          cat data_stats.txt
        fi

  # 3ë‹¨ê³„: ë°°í¬ í›„ ê²€ì¦
  verify-deployment:
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” ì‚¬ì´íŠ¸ ì ‘ê·¼ì„± í™•ì¸
      run: |
        sleep 30  # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
        
        SITE_URL="${{ needs.deploy.outputs.page_url }}"
        
        if [ -n "$SITE_URL" ]; then
          echo "ğŸŒ ì‚¬ì´íŠ¸ í™•ì¸ ì¤‘: $SITE_URL"
          
          # HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")
          
          if [ "$STATUS" = "200" ]; then
            echo "âœ… ì‚¬ì´íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤."
          else
            echo "âš ï¸ ì‚¬ì´íŠ¸ ì ‘ê·¼ ìƒíƒœ: $STATUS"
          fi
        else
          echo "âš ï¸ ë°°í¬ URLì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        fi
    
    - name: ğŸ“§ Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      if: always()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      run: |
        if [ -n "$SLACK_WEBHOOK" ]; then
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            MESSAGE="âœ… ê²½ê¸°ë„ AI ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì„±ê³µ!"
          else
            MESSAGE="âŒ ê²½ê¸°ë„ AI ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$MESSAGE\"}" \
            "$SLACK_WEBHOOK"
        fi

# ì—ëŸ¬ ë°œìƒ ì‹œ ì´ìŠˆ ìë™ ìƒì„±
  create-issue-on-failure:
    if: failure()
    needs: [process-data, deploy, verify-deployment]
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“ ì‹¤íŒ¨ ì´ìŠˆ ìƒì„±
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ ìë™ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨',
            body: `
            ## ğŸ“Š ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ë¦¬í¬íŠ¸
            
            **ì‹¤í–‰ ì‹œê°„**: ${new Date().toLocaleString('ko-KR')}
            **ì›Œí¬í”Œë¡œ**: ${context.workflow}
            **ì‹¤í–‰ ID**: ${context.runId}
            
            ### ğŸ“‹ ì‹¤íŒ¨ ì •ë³´
            - **íŠ¸ë¦¬ê±°**: ${context.eventName}
            - **ë¸Œëœì¹˜**: ${context.ref}
            - **ì»¤ë°‹**: ${context.sha.substring(0, 7)}
            
            ### ğŸ”§ í•´ê²° ë°©ë²•
            1. [ì›Œí¬í”Œë¡œ ë¡œê·¸ í™•ì¸](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. ë°ì´í„° íŒŒì¼ í˜•ì‹ ê²€ì¦
            3. ìˆ˜ë™ìœ¼ë¡œ ë‹¤ì‹œ ì‹¤í–‰
            
            ### ğŸ“ ë‹´ë‹¹ì
            @yourusername
            
            ---
            *ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
            `,
            labels: ['bug', 'automation', 'high-priority']
          })